<html><head>
<link rel="stylesheet" href="include/style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Log" rel="Chapter" href="Log.html">
<link title="Event" rel="Chapter" href="Event.html">
<link title="Strategy" rel="Chapter" href="Strategy.html">
<link title="Analysis" rel="Chapter" href="Analysis.html">
<link title="Flags" rel="Chapter" href="Flags.html">
<link title="InvarManager" rel="Chapter" href="InvarManager.html">
<link title="Kind2" rel="Chapter" href="Kind2.html">
<link title="InputSystem" rel="Chapter" href="InputSystem.html">
<link title="Eval" rel="Chapter" href="Eval.html">
<link title="Ident" rel="Chapter" href="Ident.html">
<link title="Ltree" rel="Chapter" href="Ltree.html">
<link title="Model" rel="Chapter" href="Model.html">
<link title="Scope" rel="Chapter" href="Scope.html">
<link title="Simplify" rel="Chapter" href="Simplify.html">
<link title="StateVar" rel="Chapter" href="StateVar.html">
<link title="Symbol" rel="Chapter" href="Symbol.html">
<link title="TermAttr" rel="Chapter" href="TermAttr.html">
<link title="Term" rel="Chapter" href="Term.html">
<link title="Type" rel="Chapter" href="Type.html">
<link title="UfSymbol" rel="Chapter" href="UfSymbol.html">
<link title="Var" rel="Chapter" href="Var.html">
<link title="Property" rel="Chapter" href="Property.html">
<link title="SubSystem" rel="Chapter" href="SubSystem.html">
<link title="TransSys" rel="Chapter" href="TransSys.html">
<link title="Actlit" rel="Chapter" href="Actlit.html">
<link title="Base" rel="Chapter" href="Base.html">
<link title="Compress" rel="Chapter" href="Compress.html">
<link title="Step" rel="Chapter" href="Step.html">
<link title="Clause" rel="Chapter" href="Clause.html">
<link title="CooperQE" rel="Chapter" href="CooperQE.html">
<link title="Extract" rel="Chapter" href="Extract.html">
<link title="IC3" rel="Chapter" href="IC3.html">
<link title="Poly" rel="Chapter" href="Poly.html">
<link title="Presburger" rel="Chapter" href="Presburger.html">
<link title="QE" rel="Chapter" href="QE.html">
<link title="InvGenMiner" rel="Chapter" href="InvGenMiner.html">
<link title="InvGenDomain" rel="Chapter" href="InvGenDomain.html">
<link title="InvGenGraph" rel="Chapter" href="InvGenGraph.html">
<link title="InvGen" rel="Chapter" href="InvGen.html">
<link title="LockStepDriver" rel="Chapter" href="LockStepDriver.html">
<link title="InputParser" rel="Chapter" href="InputParser.html">
<link title="Interpreter" rel="Chapter" href="Interpreter.html">
<link title="LustreLexer" rel="Chapter" href="LustreLexer.html">
<link title="LustreParser" rel="Chapter" href="LustreParser.html">
<link title="LustreAst" rel="Chapter" href="LustreAst.html">
<link title="LustreIdent" rel="Chapter" href="LustreIdent.html">
<link title="LustreIndex" rel="Chapter" href="LustreIndex.html">
<link title="LustreExpr" rel="Chapter" href="LustreExpr.html">
<link title="LustreNode" rel="Chapter" href="LustreNode.html">
<link title="LustreContext" rel="Chapter" href="LustreContext.html">
<link title="LustreDeclarations" rel="Chapter" href="LustreDeclarations.html">
<link title="LustreSimplify" rel="Chapter" href="LustreSimplify.html">
<link title="LustreSlicing" rel="Chapter" href="LustreSlicing.html">
<link title="LustreTransSys" rel="Chapter" href="LustreTransSys.html">
<link title="LustreInput" rel="Chapter" href="LustreInput.html">
<link title="LustrePath" rel="Chapter" href="LustrePath.html">
<link title="NativeInput" rel="Chapter" href="NativeInput.html">
<link title="Pretty" rel="Chapter" href="Pretty.html">
<link title="SMTExpr" rel="Chapter" href="SMTExpr.html">
<link title="SMTLIBSolver" rel="Chapter" href="SMTLIBSolver.html">
<link title="SMTSolver" rel="Chapter" href="SMTSolver.html">
<link title="SolverDriver" rel="Chapter" href="SolverDriver.html">
<link title="SolverResponse" rel="Chapter" href="SolverResponse.html">
<link title="SolverSig" rel="Chapter" href="SolverSig.html">
<link title="CVC4Driver" rel="Chapter" href="CVC4Driver.html">
<link title="GenericSMTLIBDriver" rel="Chapter" href="GenericSMTLIBDriver.html">
<link title="Z3Driver" rel="Chapter" href="Z3Driver.html">
<link title="Yices2SMT2Driver" rel="Chapter" href="Yices2SMT2Driver.html">
<link title="YicesDriver" rel="Chapter" href="YicesDriver.html">
<link title="YicesLexer" rel="Chapter" href="YicesLexer.html">
<link title="YicesNative" rel="Chapter" href="YicesNative.html">
<link title="YicesResponse" rel="Chapter" href="YicesResponse.html">
<link title="Debug" rel="Chapter" href="Debug.html">
<link title="Decimal" rel="Chapter" href="Decimal.html">
<link title="Hashcons" rel="Chapter" href="Hashcons.html">
<link title="HString" rel="Chapter" href="HString.html">
<link title="HStringSExpr" rel="Chapter" href="HStringSExpr.html">
<link title="Kind2Config" rel="Chapter" href="Kind2Config.html">
<link title="Lib" rel="Chapter" href="Lib.html">
<link title="Messaging" rel="Chapter" href="Messaging.html">
<link title="Numeral" rel="Chapter" href="Numeral.html">
<link title="SExprBase" rel="Chapter" href="SExprBase.html">
<link title="SExprLexer" rel="Chapter" href="SExprLexer.html">
<link title="Stat" rel="Chapter" href="Stat.html">
<link title="TermLib" rel="Chapter" href="TermLib.html">
<link title="Trie" rel="Chapter" href="Trie.html">
<link title="Version" rel="Chapter" href="Version.html">
<link title="LustreToRust" rel="Chapter" href="LustreToRust.html">
<link title="TestgenDF" rel="Chapter" href="TestgenDF.html">
<link title="TestgenIO" rel="Chapter" href="TestgenIO.html">
<link title="TestgenModes" rel="Chapter" href="TestgenModes.html">
<link title="TestgenSolver" rel="Chapter" href="TestgenSolver.html">
<link title="TestgenStrategies" rel="Chapter" href="TestgenStrategies.html">
<link title="TestgenTree" rel="Chapter" href="TestgenTree.html">
<link title="TestgenLib" rel="Chapter" href="TestgenLib.html"><title>Kind 2 Developer's Documentation : Kind2</title>
</head>
<body>
<code class="code"><span class="comment">(*&nbsp;This&nbsp;file&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;Kind&nbsp;2&nbsp;model&nbsp;checker.

&nbsp;&nbsp;&nbsp;Copyright&nbsp;(c)&nbsp;2015&nbsp;by&nbsp;the&nbsp;Board&nbsp;of&nbsp;Trustees&nbsp;of&nbsp;the&nbsp;University&nbsp;of&nbsp;Iowa

&nbsp;&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;you
&nbsp;&nbsp;&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;You
&nbsp;&nbsp;&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at

&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;

&nbsp;&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software
&nbsp;&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,
&nbsp;&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or
&nbsp;&nbsp;&nbsp;implied.&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing
&nbsp;&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;

*)</span>

</code><table><tr><td></td><td><span class="comment">(** Top level of the Kind 2 model-checker. *)</span></td></tr></table><code class="code">

<span class="keyword">open</span>&nbsp;<span class="constructor">Lib</span>

<span class="comment">(*

module&nbsp;Dummy&nbsp;=
struct
&nbsp;&nbsp;let&nbsp;main&nbsp;_&nbsp;=&nbsp;failwith&nbsp;"not&nbsp;implemented"
&nbsp;&nbsp;let&nbsp;on_exit&nbsp;_&nbsp;=&nbsp;()
end
*)</span>

<span class="keyword">module</span>&nbsp;<span class="constructor">BMC</span>&nbsp;=&nbsp;<span class="constructor">Base</span>
<span class="keyword">module</span>&nbsp;<span class="constructor">IND</span>&nbsp;=&nbsp;<span class="constructor">Step</span>
<span class="keyword">module</span>&nbsp;<span class="constructor">IND2</span>&nbsp;=&nbsp;<span class="constructor">Step2</span>
<span class="keyword">module</span>&nbsp;<span class="constructor">TestGen</span>&nbsp;=&nbsp;<span class="constructor">TestgenDF</span>
<span class="keyword">module</span>&nbsp;<span class="constructor">C2I</span>&nbsp;=&nbsp;<span class="constructor">C2I</span>
<span class="keyword">module</span>&nbsp;<span class="constructor">C2Icnf</span>&nbsp;=&nbsp;<span class="constructor">C2Icnf</span>


<span class="comment">(*&nbsp;Hide&nbsp;existential&nbsp;type&nbsp;parameter&nbsp;of&nbsp;to&nbsp;construct&nbsp;values&nbsp;of&nbsp;'a&nbsp;InputSystem.t
&nbsp;&nbsp;&nbsp;at&nbsp;runtime&nbsp;*)</span>
<span class="keyword">type</span>&nbsp;any_input&nbsp;=
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Input</span>&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="constructor">InputSystem</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;any_input

<span class="keyword">let</span>&nbsp;children_pgid&nbsp;=&nbsp;ref&nbsp;0

<span class="comment">(*&nbsp;Child&nbsp;processes&nbsp;forked

&nbsp;&nbsp;&nbsp;This&nbsp;is&nbsp;an&nbsp;association&nbsp;list&nbsp;of&nbsp;PID&nbsp;to&nbsp;process&nbsp;type.&nbsp;We&nbsp;need&nbsp;a
&nbsp;&nbsp;&nbsp;reference&nbsp;here,&nbsp;because&nbsp;we&nbsp;may&nbsp;need&nbsp;to&nbsp;terminate&nbsp;asynchronously
&nbsp;&nbsp;&nbsp;after&nbsp;an&nbsp;exception.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;child_pids&nbsp;=&nbsp;ref&nbsp;[]

<span class="comment">(*&nbsp;Input&nbsp;system.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;input_sys_ref&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span>
<span class="comment">(*&nbsp;Current&nbsp;input&nbsp;system.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;cur_input_sys&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span>
<span class="comment">(*&nbsp;Current&nbsp;analysis&nbsp;params.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;cur_aparam&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span>
<span class="comment">(*&nbsp;Current&nbsp;transition&nbsp;system.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;cur_trans_sys&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span>


<span class="comment">(*&nbsp;let&nbsp;get_input_sys_ref&nbsp;()&nbsp;=&nbsp;*)</span>
<span class="comment">(*&nbsp;&nbsp;&nbsp;let&nbsp;Input&nbsp;i&nbsp;=&nbsp;get&nbsp;!input_sys_ref&nbsp;in&nbsp;i&nbsp;*)</span>

<span class="comment">(*&nbsp;Generic&nbsp;signal&nbsp;handler.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;generic_sig_handler&nbsp;=&nbsp;<span class="constructor">Sys</span>.<span class="constructor">Signal_handle</span>&nbsp;exception_on_signal
<span class="comment">(*&nbsp;Installs&nbsp;a&nbsp;generic&nbsp;signal&nbsp;handler&nbsp;for&nbsp;a&nbsp;signal.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;set_generic_handler_for&nbsp;s&nbsp;=
&nbsp;&nbsp;<span class="constructor">Sys</span>.set_signal&nbsp;s&nbsp;generic_sig_handler

<span class="comment">(*&nbsp;Installs&nbsp;the&nbsp;relevant&nbsp;handler&nbsp;for&nbsp;sigalrm:
&nbsp;&nbsp;&nbsp;-&nbsp;default&nbsp;if&nbsp;no&nbsp;timeout,&nbsp;or
&nbsp;&nbsp;&nbsp;-&nbsp;[timeout]&nbsp;-&nbsp;[Stat.total_time]&nbsp;if&nbsp;there&nbsp;is&nbsp;one.
&nbsp;&nbsp;&nbsp;Raises&nbsp;[TimeoutWall]&nbsp;if&nbsp;[timeout]&nbsp;&lt;&nbsp;[Stat.total_time].&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;set_sigalrm_handler&nbsp;()&nbsp;=
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Flags</span>.timeout_wall&nbsp;()&nbsp;<span class="keyword">with</span>

&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;timeout&nbsp;<span class="keyword">when</span>&nbsp;timeout&nbsp;&gt;&nbsp;0.&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Retrieving&nbsp;total&nbsp;time.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;elapsed&nbsp;=&nbsp;<span class="constructor">Stat</span>.get_float&nbsp;<span class="constructor">Stat</span>.total_time&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;timeout&nbsp;&lt;&nbsp;elapsed&nbsp;<span class="keyword">then</span>&nbsp;raise&nbsp;<span class="constructor">TimeoutWall</span>&nbsp;<span class="keyword">else</span>&nbsp;(

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Install&nbsp;signal&nbsp;handler&nbsp;for&nbsp;SIGALRM&nbsp;after&nbsp;wallclock&nbsp;timeout.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sys</span>.set_signal&nbsp;<span class="constructor">Sys</span>.sigalrm&nbsp;(<span class="constructor">Sys</span>.<span class="constructor">Signal_handle</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">TimeoutWall</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Set&nbsp;interval&nbsp;timer&nbsp;for&nbsp;wallclock&nbsp;timeout.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Unix</span>.setitimer&nbsp;<span class="constructor">Unix</span>.<span class="constructor">ITIMER_REAL</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Unix</span>.it_interval&nbsp;=&nbsp;0.&nbsp;;&nbsp;<span class="constructor">Unix</span>.it_value&nbsp;=&nbsp;timeout&nbsp;-.&nbsp;elapsed
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;|&gt;&nbsp;ignore

&nbsp;&nbsp;&nbsp;&nbsp;)

&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;No&nbsp;timeout.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;_&nbsp;<span class="comment">(*&nbsp;{&nbsp;Unix.it_interval&nbsp;=&nbsp;i;&nbsp;Unix.it_value&nbsp;=&nbsp;v&nbsp;}&nbsp;*)</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Unix</span>.setitimer
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Unix</span>.<span class="constructor">ITIMER_REAL</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;<span class="constructor">Unix</span>.it_interval&nbsp;=&nbsp;0.;&nbsp;<span class="constructor">Unix</span>.it_value&nbsp;=&nbsp;0.&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Install&nbsp;generic&nbsp;signal&nbsp;handler&nbsp;for&nbsp;SIGALRM.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;set_generic_handler_for&nbsp;<span class="constructor">Sys</span>.sigalrm

<span class="comment">(*&nbsp;Renices&nbsp;the&nbsp;current&nbsp;process.&nbsp;Used&nbsp;for&nbsp;invariant&nbsp;generation.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;renice&nbsp;()&nbsp;=
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nice&nbsp;=&nbsp;&nbsp;(<span class="constructor">Flags</span>.<span class="constructor">Invgen</span>.renice&nbsp;())&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;nice&nbsp;&lt;&nbsp;0&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_info</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Ignoring&nbsp;negative&nbsp;niceness&nbsp;value&nbsp;for&nbsp;invariant&nbsp;generation."</span>

&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;nice&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nice'&nbsp;=&nbsp;<span class="constructor">Unix</span>.nice&nbsp;nice&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_info</span>&nbsp;<span class="string">"Renicing&nbsp;invariant&nbsp;generation&nbsp;to&nbsp;%d"</span>&nbsp;nice'

<span class="comment">(*&nbsp;Main&nbsp;function&nbsp;of&nbsp;the&nbsp;process&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;main_of_process&nbsp;=&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IC3</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">IC3</span>.main
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">BMC</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">BMC</span>.main
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IND</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">IND</span>.main
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IND2</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">IND2</span>.main
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">INVGEN</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;renice&nbsp;()&nbsp;;&nbsp;<span class="constructor">InvGen</span>.main&nbsp;<span class="keyword">true</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">INVGENOS</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;renice&nbsp;()&nbsp;;&nbsp;<span class="constructor">InvGen</span>.main&nbsp;<span class="keyword">false</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">C2I</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;renice&nbsp;()&nbsp;;&nbsp;<span class="constructor">C2I</span>.main
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Interpreter</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Interpreter</span>.main&nbsp;(<span class="constructor">Flags</span>.<span class="constructor">Interpreter</span>.input_file&nbsp;())
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">InvarManager</span>.main&nbsp;child_pids
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Parser</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Certif</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keyword">fun</span>&nbsp;_&nbsp;_&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;())

<span class="comment">(*&nbsp;Cleanup&nbsp;function&nbsp;of&nbsp;the&nbsp;process&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;on_exit_of_process&nbsp;=&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IC3</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">IC3</span>.on_exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">BMC</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">BMC</span>.on_exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IND</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">IND</span>.on_exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IND2</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">IND2</span>.on_exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">INVGEN</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">InvGen</span>.exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">INVGENOS</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">InvGen</span>.exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">C2I</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">C2I</span>.on_exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Interpreter</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Interpreter</span>.on_exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">InvarManager</span>.on_exit
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Parser</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Certif</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ignore

<span class="comment">(*
(*&nbsp;Messaging&nbsp;type&nbsp;of&nbsp;the&nbsp;process&nbsp;*)
let&nbsp;init_messaging_of_process&nbsp;=&nbsp;function&nbsp;
&nbsp;&nbsp;|&nbsp;`IC3&nbsp;-&gt;&nbsp;Kind2Message.init_ic3
&nbsp;&nbsp;|&nbsp;`BMC&nbsp;-&gt;&nbsp;Kind2Message.init_bmc
&nbsp;&nbsp;|&nbsp;`IND&nbsp;-&gt;&nbsp;Kind2Message.init_indStep
&nbsp;&nbsp;|&nbsp;`INVGEN&nbsp;-&gt;&nbsp;Kind2Message.init_invarGen&nbsp;
&nbsp;&nbsp;|&nbsp;`Supervisor&nbsp;-&gt;&nbsp;Kind2Message.init_invarManager&nbsp;(List.map&nbsp;fst&nbsp;!child_pids)
*)</span>


<span class="keyword">let</span>&nbsp;debug_ext_of_process&nbsp;=&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IC3</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"ic3"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">BMC</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"bmc"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IND</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"ind"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">IND2</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"ind2"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">INVGEN</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"invgenTS"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">INVGENOS</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"invgenOS"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">C2I</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"c2i"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Interpreter</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"interp"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Parser</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"parser"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Certif</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"certif"</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"super"</span>

<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;if&nbsp;timeout&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_timeout&nbsp;=&nbsp;0
<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;if&nbsp;one&nbsp;property&nbsp;is&nbsp;falsifiable.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_unsafe&nbsp;=&nbsp;10
<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;if&nbsp;all&nbsp;properties&nbsp;are&nbsp;valid.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_safe&nbsp;=&nbsp;20

<span class="comment">(*&nbsp;Decides&nbsp;what&nbsp;the&nbsp;exit&nbsp;status&nbsp;is&nbsp;by&nbsp;looking&nbsp;at&nbsp;a&nbsp;transition&nbsp;system.

&nbsp;&nbsp;&nbsp;The&nbsp;exit&nbsp;status&nbsp;is
&nbsp;&nbsp;&nbsp;*&nbsp;0&nbsp;if&nbsp;some&nbsp;properties&nbsp;are&nbsp;unknown&nbsp;or&nbsp;k-true&nbsp;(timeout),
&nbsp;&nbsp;&nbsp;*&nbsp;10&nbsp;if&nbsp;some&nbsp;properties&nbsp;are&nbsp;falsifiable&nbsp;(unsafe),
&nbsp;&nbsp;&nbsp;*&nbsp;20&nbsp;if&nbsp;all&nbsp;properties&nbsp;are&nbsp;invariants&nbsp;(safe).&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_of_trans_sys&nbsp;sys&nbsp;=
&nbsp;&nbsp;<span class="comment">(*&nbsp;Checking&nbsp;if&nbsp;some&nbsp;properties&nbsp;are&nbsp;unknown&nbsp;of&nbsp;falsifiable.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;unknown,&nbsp;falsifiable&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">TransSys</span>.get_prop_status_all_nocands&nbsp;sys
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.fold_left&nbsp;(<span class="keyword">fun</span>&nbsp;(u,f)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(n,&nbsp;<span class="constructor">Property</span>.<span class="constructor">PropUnknown</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(n,&nbsp;<span class="constructor">Property</span>.<span class="constructor">PropKTrue</span>&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Format</span>.eprintf&nbsp;<span class="string">"%s&nbsp;KU@."</span>&nbsp;n;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u+1,f
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(n,&nbsp;<span class="constructor">Property</span>.<span class="constructor">PropFalse</span>&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Format</span>.eprintf&nbsp;<span class="string">"%s&nbsp;FALSE@."</span>&nbsp;n;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u,f+1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;u,f
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;(0,0)
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="keyword">fun</span>&nbsp;(u,f)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;u&nbsp;&gt;&nbsp;0,&nbsp;f&nbsp;&gt;&nbsp;0
&nbsp;&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Getting&nbsp;relevant&nbsp;exit&nbsp;code.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;exit_status&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;unknown&nbsp;<span class="keyword">then</span>&nbsp;status_timeout
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;falsifiable&nbsp;<span class="keyword">then</span>&nbsp;status_unsafe
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;status_safe
&nbsp;&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Exit&nbsp;status.&nbsp;*)</span>
&nbsp;&nbsp;exit_status

<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;if&nbsp;child&nbsp;caught&nbsp;a&nbsp;signal,&nbsp;the&nbsp;signal&nbsp;number&nbsp;is&nbsp;added&nbsp;to
&nbsp;&nbsp;&nbsp;the&nbsp;value&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_signal&nbsp;=&nbsp;128

<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;if&nbsp;child&nbsp;raised&nbsp;an&nbsp;exception&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_error&nbsp;=&nbsp;2

<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;from&nbsp;an&nbsp;optional&nbsp;[results].&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_of_sys&nbsp;sys_opt&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;sys_opt&nbsp;<span class="keyword">with</span>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Format</span>.eprintf&nbsp;<span class="string">"NOSYS@."</span>;&nbsp;status_timeout
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;sys&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;status_of_trans_sys&nbsp;sys

<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;from&nbsp;an&nbsp;optional&nbsp;[results].&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_of_results&nbsp;results_opt&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;results_opt&nbsp;<span class="keyword">with</span>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Format</span>.eprintf&nbsp;<span class="string">"NORES@."</span>;&nbsp;status_timeout
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;results&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Analysis</span>.results_is_safe&nbsp;results&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Format</span>.eprintf&nbsp;<span class="string">"NOSAFERES@."</span>;&nbsp;status_timeout
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;status_safe
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;status_unsafe
)

<span class="comment">(*&nbsp;Return&nbsp;the&nbsp;status&nbsp;code&nbsp;from&nbsp;an&nbsp;exception&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;status_of_exn&nbsp;process&nbsp;status&nbsp;=&nbsp;<span class="keyword">function</span>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Normal&nbsp;termination&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Exit</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;status

&nbsp;&nbsp;<span class="comment">(*&nbsp;Got&nbsp;unknown,&nbsp;issue&nbsp;error&nbsp;but&nbsp;normal&nbsp;termination.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">SMTSolver</span>.<span class="constructor">Unknown</span>&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_error</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"In&nbsp;%a:&nbsp;a&nbsp;check-sat&nbsp;resulted&nbsp;in&nbsp;\"unknown\",&nbsp;exiting."</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pp_print_kind_module&nbsp;process&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;status

&nbsp;&nbsp;<span class="comment">(*&nbsp;Termination&nbsp;message&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Event</span>.<span class="constructor">Terminate</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(

&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_debug</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Received&nbsp;termination&nbsp;message"</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;status

&nbsp;&nbsp;)&nbsp;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Catch&nbsp;wallclock&nbsp;timeout&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">TimeoutWall</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(

&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_timeout&nbsp;<span class="keyword">true</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;status

&nbsp;&nbsp;)&nbsp;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Catch&nbsp;CPU&nbsp;timeout&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">TimeoutVirtual</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(

&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_timeout&nbsp;<span class="keyword">false</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;status

&nbsp;&nbsp;)&nbsp;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Signal&nbsp;caught&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Signal</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(

&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_interruption&nbsp;s&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Return&nbsp;exit&nbsp;status&nbsp;and&nbsp;signal&nbsp;number&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;status_signal&nbsp;+&nbsp;s

&nbsp;&nbsp;)

&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Failure</span>&nbsp;msg&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Runtime&nbsp;failure&nbsp;in&nbsp;%a:&nbsp;%s"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pp_print_kind_module&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;status_error

&nbsp;&nbsp;<span class="comment">(*&nbsp;Other&nbsp;exception,&nbsp;return&nbsp;exit&nbsp;status&nbsp;for&nbsp;error.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Runtime&nbsp;error&nbsp;in&nbsp;%a:&nbsp;%s"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pp_print_kind_module&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;status_error

<span class="keyword">let</span>&nbsp;status_of_exn_sys&nbsp;process&nbsp;sys_opt&nbsp;=
&nbsp;&nbsp;status_of_exn&nbsp;process&nbsp;(status_of_sys&nbsp;sys_opt)

<span class="keyword">let</span>&nbsp;status_of_exn_results&nbsp;process&nbsp;results_opt&nbsp;=
&nbsp;&nbsp;status_of_exn&nbsp;process&nbsp;(status_of_results&nbsp;results_opt)

<span class="comment">(*&nbsp;Kill&nbsp;all&nbsp;kids&nbsp;violently.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;slaughter_kids&nbsp;process&nbsp;sys&nbsp;=

&nbsp;&nbsp;<span class="comment">(*&nbsp;Ignore&nbsp;SIGALRM&nbsp;from&nbsp;now&nbsp;on&nbsp;*)</span>
&nbsp;&nbsp;<span class="constructor">Sys</span>.set_signal&nbsp;<span class="constructor">Sys</span>.sigalrm&nbsp;<span class="constructor">Sys</span>.<span class="constructor">Signal_ignore</span>&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Clean&nbsp;exit&nbsp;from&nbsp;invariant&nbsp;manager&nbsp;*)</span>
&nbsp;&nbsp;<span class="constructor">InvarManager</span>.on_exit&nbsp;sys&nbsp;;

&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_info</span>&nbsp;<span class="string">"Killing&nbsp;all&nbsp;remaining&nbsp;child&nbsp;processes"</span>;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Kill&nbsp;all&nbsp;child&nbsp;processes&nbsp;groups&nbsp;*)</span>
&nbsp;&nbsp;<span class="constructor">List</span>.iter
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">function</span>&nbsp;pid,&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_debug</span>&nbsp;<span class="string">"Sending&nbsp;SIGKILL&nbsp;to&nbsp;PID&nbsp;%d"</span>&nbsp;pid&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Unix</span>.kill&nbsp;(-&nbsp;pid)&nbsp;<span class="constructor">Sys</span>.sigkill&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;())

&nbsp;&nbsp;&nbsp;&nbsp;!child_pids&nbsp;;

&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_debug</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Waiting&nbsp;for&nbsp;remaining&nbsp;child&nbsp;processes&nbsp;to&nbsp;terminate"</span>&nbsp;;

&nbsp;&nbsp;(<span class="keyword">try</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">do</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Wait&nbsp;for&nbsp;child&nbsp;process&nbsp;to&nbsp;terminate&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pid,&nbsp;status&nbsp;=&nbsp;<span class="constructor">Unix</span>.wait&nbsp;()&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Remove&nbsp;killed&nbsp;process&nbsp;from&nbsp;list&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_pids&nbsp;:=&nbsp;<span class="constructor">List</span>.remove_assoc&nbsp;pid&nbsp;!child_pids&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Log&nbsp;termination&nbsp;status&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_debug</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Process&nbsp;%d&nbsp;%a"</span>&nbsp;pid&nbsp;pp_print_process_status&nbsp;status
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">done</span>
&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>

&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;No&nbsp;more&nbsp;child&nbsp;processes,&nbsp;this&nbsp;is&nbsp;the&nbsp;normal&nbsp;exit&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Unix</span>.<span class="constructor">Unix_error</span>&nbsp;(<span class="constructor">Unix</span>.<span class="constructor">ECHILD</span>,&nbsp;_,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_info</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"All&nbsp;child&nbsp;processes&nbsp;terminated."</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Unix.wait&nbsp;was&nbsp;interrupted&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Unix</span>.<span class="constructor">Unix_error</span>&nbsp;(<span class="constructor">Unix</span>.<span class="constructor">EINTR</span>,&nbsp;_,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Ignoring&nbsp;exit&nbsp;code,&nbsp;whatever&nbsp;happened&nbsp;does&nbsp;not&nbsp;change&nbsp;the
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outcome&nbsp;of&nbsp;the&nbsp;analysis.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status_of_exn_sys&nbsp;process&nbsp;<span class="constructor">None</span>&nbsp;(<span class="constructor">Signal</span>&nbsp;0)&nbsp;|&gt;&nbsp;ignore

&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Exception&nbsp;in&nbsp;Unix.wait&nbsp;loop&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Ignoring&nbsp;exit&nbsp;code,&nbsp;whatever&nbsp;happened&nbsp;does&nbsp;not&nbsp;change&nbsp;the
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outcome&nbsp;of&nbsp;the&nbsp;analysis.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status_of_exn_sys&nbsp;process&nbsp;<span class="constructor">None</span>&nbsp;e&nbsp;|&gt;&nbsp;ignore&nbsp;;
&nbsp;&nbsp;);

&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!child_pids&nbsp;&lt;&gt;&nbsp;[]&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>&nbsp;<span class="string">"Some&nbsp;children&nbsp;did&nbsp;not&nbsp;exit."</span>;
&nbsp;&nbsp;
&nbsp;&nbsp;<span class="comment">(*&nbsp;Install&nbsp;generic&nbsp;signal&nbsp;handler&nbsp;for&nbsp;SIGALRM.&nbsp;*)</span>
&nbsp;&nbsp;set_generic_handler_for&nbsp;<span class="constructor">Sys</span>.sigalrm&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Cleaning&nbsp;kids&nbsp;list.&nbsp;*)</span>
&nbsp;&nbsp;child_pids&nbsp;:=&nbsp;[]&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Draining&nbsp;mailbox.&nbsp;*)</span>
&nbsp;&nbsp;<span class="constructor">Event</span>.recv&nbsp;()&nbsp;|&gt;&nbsp;ignore&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Restore&nbsp;sigalrm&nbsp;handler&nbsp;for&nbsp;next&nbsp;analysis&nbsp;if&nbsp;any.&nbsp;*)</span>
&nbsp;&nbsp;set_sigalrm_handler&nbsp;()



<span class="comment">(*&nbsp;Called&nbsp;after&nbsp;everything&nbsp;has&nbsp;been&nbsp;cleaned&nbsp;up.&nbsp;All&nbsp;kids&nbsp;dead&nbsp;etc.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;clean_exit&nbsp;process&nbsp;results&nbsp;exn&nbsp;=

&nbsp;&nbsp;<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;of&nbsp;process&nbsp;depends&nbsp;on&nbsp;exception&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;status&nbsp;=&nbsp;status_of_exn_results&nbsp;process&nbsp;results&nbsp;exn&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Close&nbsp;tags&nbsp;in&nbsp;XML&nbsp;output&nbsp;*)</span>
&nbsp;&nbsp;<span class="constructor">Event</span>.terminate_log&nbsp;()&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Exit&nbsp;with&nbsp;status&nbsp;*)</span>
&nbsp;&nbsp;exit&nbsp;status

<span class="comment">(*&nbsp;Clean&nbsp;up&nbsp;before&nbsp;exit&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;on_exit&nbsp;process&nbsp;results&nbsp;exn&nbsp;=

<span class="comment">(*
&nbsp;&nbsp;let&nbsp;pp_print_hashcons_stat&nbsp;ppf&nbsp;(l,&nbsp;c,&nbsp;t,&nbsp;s,&nbsp;m,&nbsp;g)&nbsp;=

&nbsp;&nbsp;&nbsp;&nbsp;Format.fprintf
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ppf
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Number&nbsp;of&nbsp;buckets:&nbsp;%d@,\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Number&nbsp;of&nbsp;entries&nbsp;in&nbsp;table:&nbsp;%d@,\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sum&nbsp;of&nbsp;sizes&nbsp;of&nbsp;buckets:&nbsp;%d@,\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Size&nbsp;of&nbsp;smallest&nbsp;bucket:&nbsp;%d@,\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Median&nbsp;bucket&nbsp;size:&nbsp;%d@,\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Size&nbsp;of&nbsp;greatest&nbsp;bucket:&nbsp;%d@,"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g

&nbsp;&nbsp;in

&nbsp;&nbsp;Event.log&nbsp;L_info
&nbsp;&nbsp;&nbsp;&nbsp;"@[&lt;hv&gt;Hashconsing&nbsp;for&nbsp;state&nbsp;variables:@,%a@]"
&nbsp;&nbsp;&nbsp;&nbsp;pp_print_hashcons_stat&nbsp;(StateVar.stats&nbsp;());

&nbsp;&nbsp;Event.log&nbsp;L_info
&nbsp;&nbsp;&nbsp;&nbsp;"@[&lt;hv&gt;Hashconsing&nbsp;for&nbsp;variables:@,%a@]"
&nbsp;&nbsp;&nbsp;&nbsp;pp_print_hashcons_stat&nbsp;(Var.stats&nbsp;());

&nbsp;&nbsp;Event.log&nbsp;L_info
&nbsp;&nbsp;&nbsp;&nbsp;"@[&lt;hv&gt;Hashconsing&nbsp;for&nbsp;terms:@,%a@]"
&nbsp;&nbsp;&nbsp;&nbsp;pp_print_hashcons_stat&nbsp;(Term.stats&nbsp;());

&nbsp;&nbsp;Event.log&nbsp;L_info
&nbsp;&nbsp;&nbsp;&nbsp;"@[&lt;hv&gt;Hashconsing&nbsp;for&nbsp;symbols:@,%a@]"
&nbsp;&nbsp;&nbsp;&nbsp;pp_print_hashcons_stat&nbsp;(Symbol.stats&nbsp;());
*)</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Killing&nbsp;kids.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">try</span>
&nbsp;&nbsp;&nbsp;&nbsp;slaughter_kids&nbsp;process&nbsp;(!cur_trans_sys)
&nbsp;&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We're&nbsp;past&nbsp;the&nbsp;timeout,&nbsp;but&nbsp;we're&nbsp;exiting&nbsp;anyways.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">TimeoutWall</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Exiting.&nbsp;*)</span>
&nbsp;&nbsp;clean_exit&nbsp;process&nbsp;<span class="constructor">None</span>&nbsp;exn


<span class="comment">(*&nbsp;Call&nbsp;cleanup&nbsp;function&nbsp;of&nbsp;process&nbsp;and&nbsp;exit.

&nbsp;&nbsp;&nbsp;Give&nbsp;the&nbsp;exception&nbsp;[exn]&nbsp;that&nbsp;was&nbsp;raised&nbsp;or&nbsp;[Exit]&nbsp;on&nbsp;normal
&nbsp;&nbsp;&nbsp;termination.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;on_exit_child&nbsp;?(alone=<span class="keyword">false</span>)&nbsp;messaging_thread&nbsp;process&nbsp;exn&nbsp;=

&nbsp;&nbsp;<span class="comment">(*&nbsp;Exit&nbsp;status&nbsp;of&nbsp;process&nbsp;depends&nbsp;on&nbsp;exception&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;status&nbsp;=&nbsp;status_of_exn&nbsp;process&nbsp;0&nbsp;exn&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Call&nbsp;cleanup&nbsp;of&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;(on_exit_of_process&nbsp;process)&nbsp;!cur_trans_sys&nbsp;;

&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_debug</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Process&nbsp;%d&nbsp;terminating"</span>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Unix</span>.getpid&nbsp;())&nbsp;;

&nbsp;&nbsp;(&nbsp;<span class="keyword">match</span>&nbsp;messaging_thread&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Event</span>.exit&nbsp;t
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()&nbsp;)&nbsp;;

&nbsp;&nbsp;<span class="constructor">Debug</span>.kind2
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Process&nbsp;%a&nbsp;terminating"</span>&nbsp;pp_print_kind_module&nbsp;process&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Log&nbsp;stats&nbsp;and&nbsp;statuses&nbsp;of&nbsp;properties&nbsp;if&nbsp;run&nbsp;as&nbsp;a&nbsp;single&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;alone&nbsp;then&nbsp;Event.log_result&nbsp;sys_opt;&nbsp;*)</span>

&nbsp;&nbsp;<span class="constructor">Event</span>.terminate_log&nbsp;();

&nbsp;&nbsp;<span class="comment">(*&nbsp;Exit&nbsp;process&nbsp;with&nbsp;status&nbsp;*)</span>
&nbsp;&nbsp;exit&nbsp;status



<span class="comment">(*&nbsp;Fork&nbsp;and&nbsp;run&nbsp;a&nbsp;child&nbsp;process&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;run_process&nbsp;messaging_setup&nbsp;process&nbsp;=

&nbsp;&nbsp;<span class="comment">(*&nbsp;Fork&nbsp;a&nbsp;new&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pid&nbsp;=&nbsp;<span class="constructor">Unix</span>.fork&nbsp;()&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pid&nbsp;<span class="keyword">with</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;are&nbsp;the&nbsp;child&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;0&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Make&nbsp;the&nbsp;process&nbsp;leader&nbsp;of&nbsp;a&nbsp;new&nbsp;session&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(<span class="constructor">Unix</span>.setsid&nbsp;());

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pid&nbsp;=&nbsp;<span class="constructor">Unix</span>.getpid&nbsp;()&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Ignore&nbsp;SIGALRM&nbsp;in&nbsp;child&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sys</span>.set_signal&nbsp;<span class="constructor">Sys</span>.sigalrm&nbsp;<span class="constructor">Sys</span>.<span class="constructor">Signal_ignore</span>;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Initialize&nbsp;mtessaging&nbsp;system&nbsp;for&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;messaging_thread&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.run_process&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messaging_setup
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on_exit_child&nbsp;<span class="constructor">None</span>&nbsp;process)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;All&nbsp;log&nbsp;messages&nbsp;are&nbsp;sent&nbsp;to&nbsp;the&nbsp;invariant&nbsp;manager&nbsp;now&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.set_relay_log&nbsp;();

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Set&nbsp;module&nbsp;currently&nbsp;running&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.set_module&nbsp;process;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Record&nbsp;backtraces&nbsp;on&nbsp;log&nbsp;levels&nbsp;debug&nbsp;and&nbsp;higher&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;output_on_level&nbsp;<span class="constructor">L_debug</span>&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Printexc</span>.record_backtrace&nbsp;<span class="keyword">true</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_debug</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Starting&nbsp;new&nbsp;process&nbsp;%a&nbsp;with&nbsp;PID&nbsp;%d"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pp_print_kind_module&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pid;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Change&nbsp;debug&nbsp;output&nbsp;to&nbsp;per&nbsp;process&nbsp;file&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Flags</span>.debug_log&nbsp;()&nbsp;<span class="keyword">with</span>&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Keep&nbsp;if&nbsp;output&nbsp;to&nbsp;stdout&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Open&nbsp;channel&nbsp;to&nbsp;given&nbsp;file&nbsp;and&nbsp;create&nbsp;formatter&nbsp;on
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;channel&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Output&nbsp;to&nbsp;f.PROCESS-PID&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f'&nbsp;=&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Format</span>.sprintf&nbsp;<span class="string">"%s.%s-%d"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(debug_ext_of_process&nbsp;process)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pid
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Open&nbsp;output&nbsp;channel&nbsp;to&nbsp;file&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;oc&nbsp;=&nbsp;open_out&nbsp;f'&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Formatter&nbsp;writing&nbsp;to&nbsp;file&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;debug_formatter&nbsp;=&nbsp;<span class="constructor">Format</span>.formatter_of_out_channel&nbsp;oc&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Debug</span>.set_formatter&nbsp;debug_formatter

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Ignore&nbsp;and&nbsp;keep&nbsp;previous&nbsp;file&nbsp;on&nbsp;error&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sys_error</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="constructor">Input</span>&nbsp;cur_in_sys&nbsp;=&nbsp;get&nbsp;!cur_input_sys&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Run&nbsp;main&nbsp;function&nbsp;of&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(main_of_process&nbsp;process)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cur_in_sys
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(get&nbsp;!cur_aparam)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(get&nbsp;!cur_trans_sys);

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Cleanup&nbsp;and&nbsp;exit&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_exit_child&nbsp;(<span class="constructor">Some</span>&nbsp;messaging_thread)&nbsp;process&nbsp;<span class="constructor">Exit</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Termination&nbsp;message&nbsp;received&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Event</span>.<span class="constructor">Terminate</span>&nbsp;<span class="keyword">as</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_exit_child&nbsp;(<span class="constructor">Some</span>&nbsp;messaging_thread)&nbsp;process&nbsp;e

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Catch&nbsp;all&nbsp;other&nbsp;exceptions&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Get&nbsp;backtrace&nbsp;now,&nbsp;Printf&nbsp;changes&nbsp;it&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;backtrace&nbsp;=&nbsp;<span class="constructor">Printexc</span>.get_raw_backtrace&nbsp;()&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Printexc</span>.backtrace_status&nbsp;()&nbsp;<span class="keyword">then</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Caught&nbsp;%s&nbsp;in&nbsp;%a.@\nBacktrace:@\n%a"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pp_print_kind_module&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_backtrace&nbsp;backtrace
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Cleanup&nbsp;and&nbsp;exit&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_exit_child&nbsp;(<span class="constructor">Some</span>&nbsp;messaging_thread)&nbsp;process&nbsp;e

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;are&nbsp;the&nbsp;parent&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Keep&nbsp;PID&nbsp;of&nbsp;child&nbsp;process&nbsp;and&nbsp;return&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_pids&nbsp;:=&nbsp;(pid,&nbsp;process)&nbsp;::&nbsp;!child_pids


<span class="comment">(*&nbsp;Setup&nbsp;everything&nbsp;and&nbsp;returns&nbsp;the&nbsp;input&nbsp;system.&nbsp;Setup&nbsp;includes:
&nbsp;&nbsp;&nbsp;-&nbsp;debug&nbsp;setup,
&nbsp;&nbsp;&nbsp;-&nbsp;log&nbsp;level&nbsp;setup,
&nbsp;&nbsp;&nbsp;-&nbsp;smt&nbsp;solver&nbsp;setup,
&nbsp;&nbsp;&nbsp;-&nbsp;timeout&nbsp;setup,
&nbsp;&nbsp;&nbsp;-&nbsp;signal&nbsp;handling,
&nbsp;&nbsp;&nbsp;-&nbsp;starting&nbsp;global&nbsp;timer,
&nbsp;&nbsp;&nbsp;-&nbsp;parsing&nbsp;input&nbsp;file,
&nbsp;&nbsp;&nbsp;-&nbsp;building&nbsp;input&nbsp;system.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;setup&nbsp;:&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;any_input&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Formatter&nbsp;to&nbsp;write&nbsp;debug&nbsp;output&nbsp;to.&nbsp;*)</span>
&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;<span class="constructor">Flags</span>.debug_log&nbsp;()&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Write&nbsp;to&nbsp;stdout&nbsp;by&nbsp;default.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Open&nbsp;channel&nbsp;to&nbsp;given&nbsp;file&nbsp;and&nbsp;create&nbsp;formatter&nbsp;on&nbsp;channel.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;oc&nbsp;=&nbsp;<span class="keyword">try</span>&nbsp;open_out&nbsp;f&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Sys_error</span>&nbsp;msg&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Format</span>.sprintf
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Could&nbsp;not&nbsp;open&nbsp;debug&nbsp;logfile&nbsp;\"%s\":&nbsp;\"%s\""</span>&nbsp;f&nbsp;msg
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;failwith
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Debug</span>.set_formatter&nbsp;(<span class="constructor">Format</span>.formatter_of_out_channel&nbsp;oc)
&nbsp;&nbsp;)&nbsp;;


&nbsp;&nbsp;<span class="comment">(*&nbsp;Record&nbsp;backtraces&nbsp;on&nbsp;log&nbsp;levels&nbsp;debug&nbsp;and&nbsp;higher.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;output_on_level&nbsp;<span class="constructor">L_debug</span>&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Printexc</span>.record_backtrace&nbsp;<span class="keyword">true</span>&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Set&nbsp;sigalrm&nbsp;handler.&nbsp;*)</span>
&nbsp;&nbsp;set_sigalrm_handler&nbsp;()&nbsp;;

&nbsp;&nbsp;<span class="comment">(*
&nbsp;&nbsp;&nbsp;&nbsp;/!\&nbsp;==================================================================&nbsp;/!\
&nbsp;&nbsp;&nbsp;&nbsp;/!\&nbsp;Must&nbsp;not&nbsp;use&nbsp;[vtalrm]&nbsp;signal,&nbsp;this&nbsp;is&nbsp;used&nbsp;internally&nbsp;by&nbsp;the&nbsp;OCaml&nbsp;/!\
&nbsp;&nbsp;&nbsp;&nbsp;/!\&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Threads]&nbsp;module.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/!\
&nbsp;&nbsp;&nbsp;&nbsp;/!\&nbsp;==================================================================&nbsp;/!\
&nbsp;&nbsp;*)</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Raise&nbsp;exception&nbsp;on&nbsp;CTRL+C.&nbsp;*)</span>
&nbsp;&nbsp;<span class="constructor">Sys</span>.catch_break&nbsp;<span class="keyword">true</span>&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Install&nbsp;generic&nbsp;signal&nbsp;handler&nbsp;for&nbsp;SIGINT,&nbsp;SIGPIPE,&nbsp;SIGTERM&nbsp;and&nbsp;SIGQUIT.&nbsp;*)</span>
&nbsp;&nbsp;[&nbsp;<span class="constructor">Sys</span>.sigint&nbsp;;&nbsp;<span class="constructor">Sys</span>.sigpipe;&nbsp;<span class="constructor">Sys</span>.sigterm&nbsp;;&nbsp;<span class="constructor">Sys</span>.sigquit&nbsp;]
&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.iter&nbsp;set_generic_handler_for&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Starting&nbsp;global&nbsp;timer.&nbsp;*)</span>
&nbsp;&nbsp;<span class="constructor">Stat</span>.start_timer&nbsp;<span class="constructor">Stat</span>.total_time&nbsp;;

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;in_file&nbsp;=&nbsp;<span class="constructor">Flags</span>.input_file&nbsp;()&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_info</span>&nbsp;<span class="string">"Parsing&nbsp;%s."</span>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;in_file&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"standard&nbsp;input"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"input&nbsp;file&nbsp;\""</span>&nbsp;^&nbsp;in_file&nbsp;^&nbsp;<span class="string">"\""</span>);

&nbsp;&nbsp;<span class="keyword">try</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;in_file&nbsp;|&gt;&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Flags</span>.input_format&nbsp;()&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Lustre</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Input</span>&nbsp;(<span class="constructor">InputSystem</span>.read_input_lustre&nbsp;in_file)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Native</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Input</span>&nbsp;(<span class="constructor">InputSystem</span>.read_input_native&nbsp;in_file)
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Horn</span>&nbsp;&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="comment">(*&nbsp;InputSystem.read_input_horn&nbsp;*)</span>&nbsp;&nbsp;&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="comment">(*&nbsp;Could&nbsp;not&nbsp;create&nbsp;input&nbsp;system.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">LustreAst</span>.<span class="constructor">Parser_error</span>&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Don't&nbsp;do&nbsp;anything&nbsp;for&nbsp;parser&nbsp;error,&nbsp;they&nbsp;should&nbsp;already&nbsp;have&nbsp;printed
&nbsp;&nbsp;&nbsp;&nbsp;some&nbsp;stuff.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.terminate_log&nbsp;()&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;status_error
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;backtrace&nbsp;=&nbsp;<span class="constructor">Printexc</span>.get_raw_backtrace&nbsp;()&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">L_fatal</span>&nbsp;<span class="string">"Error&nbsp;opening&nbsp;input&nbsp;file&nbsp;\"%s\":@&nbsp;%s%a"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Flags</span>.input_file&nbsp;())&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;<span class="constructor">Printexc</span>.backtrace_status&nbsp;()&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;fmt&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Format</span>.fprintf&nbsp;fmt&nbsp;<span class="string">"@\nBacktrace:@&nbsp;%a"</span>&nbsp;print_backtrace
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;())&nbsp;backtrace;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Terminating&nbsp;log&nbsp;and&nbsp;exiting&nbsp;with&nbsp;error.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.terminate_log&nbsp;()&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;status_error

<span class="keyword">let</span>&nbsp;tests_path&nbsp;=&nbsp;<span class="string">"tests"</span>
<span class="keyword">let</span>&nbsp;oracle_path&nbsp;=&nbsp;<span class="string">"oracle"</span>
<span class="keyword">let</span>&nbsp;implem_path&nbsp;=&nbsp;<span class="string">"implem"</span>

<span class="comment">(*&nbsp;Runs&nbsp;test&nbsp;generation&nbsp;on&nbsp;the&nbsp;system&nbsp;(scope)&nbsp;specified&nbsp;by&nbsp;abstracting
&nbsp;&nbsp;&nbsp;everything.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;run_testgen&nbsp;input_sys&nbsp;top&nbsp;=
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Flags</span>.<span class="constructor">Testgen</span>.active&nbsp;()&nbsp;<span class="keyword">then</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">InputSystem</span>.maximal_abstraction_for_testgen&nbsp;input_sys&nbsp;top&nbsp;[]&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_warn</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"System&nbsp;%a&nbsp;has&nbsp;no&nbsp;contracts,&nbsp;skipping&nbsp;test&nbsp;generation."</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Scope</span>.pp_print_scope&nbsp;top

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;param&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create&nbsp;root&nbsp;dir&nbsp;if&nbsp;needed.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Flags</span>.output_dir&nbsp;()&nbsp;|&gt;&nbsp;mk_dir&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target&nbsp;=&nbsp;<span class="constructor">Flags</span>.subdir_for&nbsp;top&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Create&nbsp;system&nbsp;dir&nbsp;if&nbsp;needed.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mk_dir&nbsp;target&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;param&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;param&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Analysis</span>.<span class="constructor">ContractCheck</span>&nbsp;info&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Analysis</span>.<span class="constructor">ContractCheck</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Analysis</span>.uid&nbsp;=&nbsp;info.<span class="constructor">Analysis</span>.uid&nbsp;*&nbsp;1000
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Analysis</span>.<span class="constructor">First</span>&nbsp;info&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Analysis</span>.<span class="constructor">First</span>&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Analysis</span>.uid&nbsp;=&nbsp;info.<span class="constructor">Analysis</span>.uid&nbsp;*&nbsp;1000
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Analysis</span>.<span class="constructor">Refinement</span>&nbsp;(info,&nbsp;res)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Analysis</span>.<span class="constructor">Refinement</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;info&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Analysis</span>.uid&nbsp;=&nbsp;info.<span class="constructor">Analysis</span>.uid&nbsp;*&nbsp;1000&nbsp;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Extracting&nbsp;transition&nbsp;system.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sys,&nbsp;input_sys_sliced&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InputSystem</span>.trans_sys_of_analysis&nbsp;~preserve_sig:<span class="keyword">true</span>&nbsp;input_sys&nbsp;param
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Let's&nbsp;do&nbsp;this.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tests_target&nbsp;=&nbsp;<span class="constructor">Format</span>.sprintf&nbsp;<span class="string">"%s/%s"</span>&nbsp;target&nbsp;tests_path&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mk_dir&nbsp;tests_target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_uncond
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"%sGenerating&nbsp;tests&nbsp;for&nbsp;node&nbsp;\"%a\"&nbsp;to&nbsp;`%s`."</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">TestGen</span>.log_prefix&nbsp;<span class="constructor">Scope</span>.pp_print_scope&nbsp;top&nbsp;tests_target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;testgen_xmls&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">TestGen</span>.main&nbsp;param&nbsp;input_sys_sliced&nbsp;sys&nbsp;tests_target
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Yay,&nbsp;done.&nbsp;Killing&nbsp;stuff.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">TestGen</span>.on_exit&nbsp;<span class="string">"yay"</span>&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Generate&nbsp;oracle.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;oracle_target&nbsp;=&nbsp;<span class="constructor">Format</span>.sprintf&nbsp;<span class="string">"%s/%s"</span>&nbsp;target&nbsp;oracle_path&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mk_dir&nbsp;oracle_target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_uncond
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"%sCompiling&nbsp;oracle&nbsp;to&nbsp;Rust&nbsp;for&nbsp;node&nbsp;\"%a\"&nbsp;to&nbsp;`%s`."</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">TestGen</span>.log_prefix&nbsp;<span class="constructor">Scope</span>.pp_print_scope&nbsp;top&nbsp;oracle_target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name,&nbsp;guarantees,&nbsp;modes&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InputSystem</span>.compile_oracle_to_rust&nbsp;input_sys&nbsp;top&nbsp;oracle_target
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_uncond
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"%sGenerating&nbsp;glue&nbsp;xml&nbsp;file&nbsp;to&nbsp;`%s/.`."</span>&nbsp;<span class="constructor">TestGen</span>.log_prefix&nbsp;target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;testgen_xmls
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.map&nbsp;(<span class="keyword">fun</span>&nbsp;xml&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Format</span>.sprintf&nbsp;<span class="string">"%s/%s"</span>&nbsp;tests_path&nbsp;xml)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">TestGen</span>.log_test_glue_file
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;name&nbsp;(oracle_path,&nbsp;guarantees,&nbsp;modes)&nbsp;implem_path&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_uncond
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"%sDone&nbsp;with&nbsp;test&nbsp;generation."</span>&nbsp;<span class="constructor">TestGen</span>.log_prefix
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">with</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">TestGen</span>.on_exit&nbsp;<span class="string">"T_T"</span>&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;e
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)
&nbsp;&nbsp;)

<span class="comment">(*&nbsp;Compiles&nbsp;a&nbsp;system&nbsp;(scope)&nbsp;to&nbsp;Rust.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;compile_to_rust&nbsp;input_sys&nbsp;top&nbsp;=
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Flags</span>.lus_compile&nbsp;()&nbsp;<span class="keyword">then</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Creating&nbsp;root&nbsp;dir&nbsp;if&nbsp;needed.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Flags</span>.output_dir&nbsp;()&nbsp;|&gt;&nbsp;mk_dir&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target&nbsp;=&nbsp;<span class="constructor">Flags</span>.subdir_for&nbsp;top&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Creating&nbsp;system&nbsp;subdir&nbsp;if&nbsp;needed.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;mk_dir&nbsp;target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Implementation&nbsp;directory.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target&nbsp;=&nbsp;<span class="constructor">Format</span>.sprintf&nbsp;<span class="string">"%s/%s"</span>&nbsp;target&nbsp;implem_path&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_uncond
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"[TO_RUST]&nbsp;Compiling&nbsp;node&nbsp;\"%a\"&nbsp;to&nbsp;Rust&nbsp;in&nbsp;`%s`."</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Scope</span>.pp_print_scope&nbsp;top&nbsp;target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InputSystem</span>.compile_to_rust&nbsp;input_sys&nbsp;top&nbsp;target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_uncond&nbsp;<span class="string">"[TO_RUST]&nbsp;Done&nbsp;compiling."</span>
&nbsp;&nbsp;)

<span class="comment">(*&nbsp;Generate&nbsp;certificates&nbsp;and&nbsp;or&nbsp;proofs&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;generate_certif_proofs&nbsp;uid&nbsp;input_sys&nbsp;trans_sys&nbsp;=
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Flags</span>.<span class="constructor">Certif</span>.certif&nbsp;()&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Flags</span>.<span class="constructor">Certif</span>.proof&nbsp;()&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">CertifChecker</span>.generate_all_proofs&nbsp;uid&nbsp;input_sys&nbsp;trans_sys
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">CertifChecker</span>.generate_smt2_certificates&nbsp;uid&nbsp;input_sys&nbsp;trans_sys


<span class="comment">(*&nbsp;Runs&nbsp;test&nbsp;generation&nbsp;and&nbsp;compilation&nbsp;if&nbsp;asked&nbsp;to.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;post_verif&nbsp;input_sys&nbsp;result&nbsp;=
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Analysis</span>.result_is_all_proved&nbsp;result&nbsp;<span class="keyword">then</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;trans_sys&nbsp;=&nbsp;result.<span class="constructor">Analysis</span>.sys&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;top_scope&nbsp;=&nbsp;<span class="constructor">TransSys</span>.scope_of_trans_sys&nbsp;trans_sys&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;run_testgen&nbsp;input_sys&nbsp;top_scope&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;compile_to_rust&nbsp;input_sys&nbsp;top_scope;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;uid&nbsp;=&nbsp;<span class="constructor">Analysis</span>.(info_of_param&nbsp;result.param).<span class="constructor">Analysis</span>.uid&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;generate_certif_proofs&nbsp;uid&nbsp;input_sys&nbsp;trans_sys;
&nbsp;&nbsp;)

<span class="comment">(*&nbsp;Launches&nbsp;analyses.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;run_loop&nbsp;msg_setup&nbsp;modules&nbsp;results&nbsp;=
&nbsp;&nbsp;<span class="constructor">Stat</span>.start_timer&nbsp;<span class="constructor">Stat</span>.analysis_time&nbsp;;

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aparam,&nbsp;<span class="constructor">Input</span>&nbsp;input_sys,&nbsp;trans_sys&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;get&nbsp;!cur_aparam,&nbsp;get&nbsp;!cur_input_sys,&nbsp;get&nbsp;!cur_trans_sys
&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;(&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">TransSys</span>.props_list_of_bound&nbsp;trans_sys&nbsp;<span class="constructor">Numeral</span>.zero&nbsp;<span class="keyword">with</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Flags</span>.modular&nbsp;()&nbsp;|&gt;&nbsp;not&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_warn</span>&nbsp;<span class="string">"Current&nbsp;system&nbsp;has&nbsp;no&nbsp;properties."</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;()

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;props&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Event.log&nbsp;L_fatal&nbsp;"Launching&nbsp;analysis&nbsp;with&nbsp;param&nbsp;%a"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Analysis.pp_print_param&nbsp;aparam&nbsp;;&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_analysis_start&nbsp;trans_sys&nbsp;aparam&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Output&nbsp;the&nbsp;transition&nbsp;system.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Debug</span>.parse&nbsp;<span class="string">"%a"</span>&nbsp;<span class="constructor">TransSys</span>.pp_print_trans_sys&nbsp;trans_sys;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.length&nbsp;props&nbsp;|&gt;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_info</span>&nbsp;<span class="string">"%d&nbsp;properties."</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_debug</span>&nbsp;<span class="string">"Starting&nbsp;child&nbsp;processes."</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Start&nbsp;all&nbsp;child&nbsp;processes.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;(<span class="keyword">function</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;run_process&nbsp;msg_setup&nbsp;p)&nbsp;modules&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Update&nbsp;background&nbsp;thread&nbsp;with&nbsp;new&nbsp;kids.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.update_child_processes_list&nbsp;!child_pids&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Running&nbsp;supervisor.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InvarManager</span>.main&nbsp;child_pids&nbsp;input_sys&nbsp;aparam&nbsp;trans_sys&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Killing&nbsp;kids.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;trans_sys&nbsp;|&gt;&nbsp;slaughter_kids&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>
&nbsp;&nbsp;)&nbsp;;

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Stat</span>.get_float&nbsp;<span class="constructor">Stat</span>.analysis_time&nbsp;|&gt;&nbsp;<span class="constructor">Analysis</span>.mk_result&nbsp;aparam&nbsp;trans_sys
&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="constructor">Event</span>.log_analysis_end&nbsp;result&nbsp;;

&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_info</span>&nbsp;<span class="string">"Result:&nbsp;%a"</span>&nbsp;<span class="constructor">Analysis</span>.pp_print_result&nbsp;result&nbsp;;

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;results&nbsp;=&nbsp;<span class="constructor">Analysis</span>.results_add&nbsp;result&nbsp;results&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="constructor">Input</span>&nbsp;input_sys&nbsp;=&nbsp;get&nbsp;!input_sys_ref&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">InputSystem</span>.next_analysis_of_strategy&nbsp;input_sys&nbsp;results&nbsp;<span class="keyword">with</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;No&nbsp;next&nbsp;analysis,&nbsp;done.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;results

&nbsp;&nbsp;<span class="comment">(*&nbsp;Preparing&nbsp;for&nbsp;next&nbsp;analysis.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;aparam&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Extracting&nbsp;transition&nbsp;system.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;trans_sys,&nbsp;input_sys_sliced&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InputSystem</span>.trans_sys_of_analysis&nbsp;input_sys&nbsp;aparam&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Memorizing&nbsp;things.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;cur_aparam&nbsp;&nbsp;&nbsp;&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;aparam&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;cur_input_sys&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Input</span>&nbsp;input_sys_sliced)&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;cur_trans_sys&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;trans_sys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Looping.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;run_loop&nbsp;msg_setup&nbsp;modules&nbsp;results


<span class="comment">(*&nbsp;Looks&nbsp;at&nbsp;the&nbsp;modules&nbsp;activated&nbsp;and&nbsp;decides&nbsp;what&nbsp;to&nbsp;do.&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;launch&nbsp;input_sys&nbsp;=

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;results&nbsp;=&nbsp;<span class="constructor">Analysis</span>.mk_results&nbsp;()&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="constructor">Input</span>&nbsp;in_sys&nbsp;=&nbsp;input_sys&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;
&nbsp;&nbsp;<span class="comment">(*&nbsp;Retrieving&nbsp;params&nbsp;for&nbsp;next&nbsp;analysis.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aparam&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">InputSystem</span>.next_analysis_of_strategy&nbsp;in_sys&nbsp;results&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span>
&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Building&nbsp;transition&nbsp;system&nbsp;and&nbsp;slicing&nbsp;info.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;trans_sys,&nbsp;input_sys_sliced&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InputSystem</span>.trans_sys_of_analysis&nbsp;in_sys&nbsp;aparam
&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Memorizing&nbsp;things.&nbsp;*)</span>
&nbsp;&nbsp;cur_input_sys&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Input</span>&nbsp;input_sys_sliced)&nbsp;;
&nbsp;&nbsp;cur_aparam&nbsp;&nbsp;&nbsp;&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;aparam&nbsp;;
&nbsp;&nbsp;cur_trans_sys&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;trans_sys&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Dump&nbsp;transition&nbsp;system&nbsp;in&nbsp;native&nbsp;format&nbsp;*)</span>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;Flags.dump_native&nbsp;()&nbsp;then&nbsp;NativeInput.dump_native&nbsp;trans_sys;&nbsp;*)</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Checking&nbsp;what's&nbsp;activated.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Flags</span>.enabled&nbsp;()&nbsp;<span class="keyword">with</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;No&nbsp;modules&nbsp;enabled.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>&nbsp;<span class="string">"Need&nbsp;at&nbsp;least&nbsp;one&nbsp;process&nbsp;enabled."</span>&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;status_error

&nbsp;&nbsp;<span class="comment">(*&nbsp;Only&nbsp;the&nbsp;interpreter&nbsp;is&nbsp;running.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[m]&nbsp;<span class="keyword">when</span>&nbsp;m&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Interpreter</span>&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Set&nbsp;module&nbsp;currently&nbsp;running.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.set_module&nbsp;m&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="constructor">Input</span>&nbsp;cur_sys&nbsp;=&nbsp;get&nbsp;!cur_input_sys&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Run&nbsp;interpreter.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Interpreter</span>.main
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Flags</span>.<span class="constructor">Interpreter</span>.input_file&nbsp;())
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cur_sys
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(get&nbsp;!cur_aparam)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(get&nbsp;!cur_trans_sys)&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Ignore&nbsp;SIGALRM&nbsp;from&nbsp;now&nbsp;on&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Sys</span>.set_signal&nbsp;<span class="constructor">Sys</span>.sigalrm&nbsp;<span class="constructor">Sys</span>.<span class="constructor">Signal_ignore</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Cleanup&nbsp;before&nbsp;exiting&nbsp;process&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;on_exit_child&nbsp;<span class="constructor">None</span>&nbsp;m&nbsp;<span class="constructor">Exit</span>

&nbsp;&nbsp;<span class="comment">(*&nbsp;Some&nbsp;modules,&nbsp;including&nbsp;the&nbsp;interpreter.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;modules&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">List</span>.mem&nbsp;<span class="keywordsign">`</span><span class="constructor">Interpreter</span>&nbsp;modules&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>&nbsp;<span class="string">"Cannot&nbsp;run&nbsp;the&nbsp;interpreter&nbsp;with&nbsp;other&nbsp;processes."</span>&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;status_error

&nbsp;&nbsp;<span class="comment">(*&nbsp;Some&nbsp;modules,&nbsp;not&nbsp;including&nbsp;the&nbsp;interpreter.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;modules&nbsp;<span class="keywordsign">-&gt;</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_info</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"@[&lt;hov&gt;Running&nbsp;in&nbsp;parallel&nbsp;mode:&nbsp;@[&lt;v&gt;-&nbsp;%a@]@]"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pp_print_list&nbsp;pp_print_kind_module&nbsp;<span class="string">"@&nbsp;-&nbsp;"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modules&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Setup&nbsp;messaging.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;msg_setup&nbsp;=&nbsp;<span class="constructor">Event</span>.setup&nbsp;()&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Set&nbsp;module&nbsp;currently&nbsp;running&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.set_module&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Initialize&nbsp;messaging&nbsp;for&nbsp;invariant&nbsp;manager,&nbsp;obtain&nbsp;a&nbsp;background
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thread.&nbsp;No&nbsp;kids&nbsp;yet.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.run_im&nbsp;msg_setup&nbsp;[]&nbsp;(on_exit&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>&nbsp;<span class="constructor">None</span>)&nbsp;|&gt;&nbsp;ignore&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_debug</span>&nbsp;<span class="string">"Messaging&nbsp;initialized&nbsp;in&nbsp;supervisor."</span>&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Running.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;results&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_loop&nbsp;msg_setup&nbsp;modules&nbsp;results&nbsp;|&gt;&nbsp;<span class="constructor">Analysis</span>.results_clean
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Producing&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;last&nbsp;results&nbsp;for&nbsp;each&nbsp;system,&nbsp;in&nbsp;topological
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="constructor">Input</span>&nbsp;input_sys&nbsp;=&nbsp;get&nbsp;!input_sys_ref&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_sys&nbsp;|&gt;&nbsp;<span class="constructor">InputSystem</span>.ordered_scopes_of
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;|&gt;&nbsp;fun&nbsp;syss&nbsp;-&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Format.printf&nbsp;"%d&nbsp;systems@.@."&nbsp;(List.length&nbsp;syss)&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Format.printf&nbsp;"systems:&nbsp;@[&lt;v&gt;%a@]@.@."
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pp_print_list&nbsp;Scope.pp_print_scope&nbsp;"@&nbsp;")&nbsp;syss&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;syss&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.fold_left&nbsp;(<span class="keyword">fun</span>&nbsp;l&nbsp;sys&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Format.printf&nbsp;"sys:&nbsp;%a@.@."&nbsp;Scope.pp_print_scope&nbsp;sys&nbsp;;&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Analysis</span>.results_find&nbsp;sys&nbsp;results&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;last&nbsp;::&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Running&nbsp;post&nbsp;verification&nbsp;things.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post_verif&nbsp;input_sys&nbsp;last&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last&nbsp;::&nbsp;l
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;l
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Failure</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>&nbsp;<span class="string">"Failure:&nbsp;%s"</span>&nbsp;s;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>&nbsp;<span class="string">"%s"</span>&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)&nbsp;;&nbsp;l
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;[]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Logging&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;run.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Event</span>.log_run_end&nbsp;;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clean_exit&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>&nbsp;(<span class="constructor">Some</span>&nbsp;results)&nbsp;<span class="constructor">Exit</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Get&nbsp;backtrace&nbsp;now,&nbsp;Printf&nbsp;changes&nbsp;it&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;backtrace&nbsp;=&nbsp;<span class="constructor">Printexc</span>.get_raw_backtrace&nbsp;()&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Printexc</span>.backtrace_status&nbsp;()&nbsp;<span class="keyword">then</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_fatal</span>&nbsp;<span class="string">"Caught&nbsp;%s&nbsp;in&nbsp;%a.@\nBacktrace:@\n%a"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pp_print_kind_module&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_backtrace&nbsp;backtrace;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_exit&nbsp;<span class="keywordsign">`</span><span class="constructor">Supervisor</span>&nbsp;<span class="constructor">None</span>&nbsp;e


<span class="comment">(*&nbsp;Entry&nbsp;point&nbsp;*)</span>
<span class="keyword">let</span>&nbsp;main&nbsp;()&nbsp;=

&nbsp;&nbsp;<span class="comment">(*&nbsp;Set&nbsp;everything&nbsp;up&nbsp;and&nbsp;produce&nbsp;input&nbsp;system.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_sys&nbsp;=&nbsp;setup&nbsp;()&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;input_sys_ref&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;input_sys&nbsp;;

&nbsp;&nbsp;<span class="comment">(*&nbsp;Not&nbsp;launching&nbsp;if&nbsp;we're&nbsp;just&nbsp;translating&nbsp;contracts.&nbsp;*)</span>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Flags</span>.<span class="constructor">Contracts</span>.translate_contracts&nbsp;()&nbsp;<span class="keyword">with</span>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;target&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src&nbsp;=&nbsp;<span class="constructor">Flags</span>.input_file&nbsp;()&nbsp;<span class="keyword">in</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_uncond&nbsp;<span class="string">"Translating&nbsp;contracts&nbsp;to&nbsp;file&nbsp;\"%s\""</span>&nbsp;target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InputSystem</span>.translate_contracts_lustre&nbsp;src&nbsp;target&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log_uncond&nbsp;<span class="string">"Success"</span>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">with</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_error</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Could&nbsp;not&nbsp;translate&nbsp;contracts&nbsp;from&nbsp;file&nbsp;\"%s\":@&nbsp;%s"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)
&nbsp;&nbsp;)
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(

&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Are&nbsp;we&nbsp;just&nbsp;generating&nbsp;contracts?.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Flags</span>.<span class="constructor">Contracts</span>.contract_gen&nbsp;()&nbsp;<span class="keyword">then</span>&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Event</span>.log&nbsp;<span class="constructor">L_warn</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Contract&nbsp;generation&nbsp;is&nbsp;a&nbsp;very&nbsp;experimental&nbsp;feature:@&nbsp;in&nbsp;particular,&nbsp;the&nbsp;modes&nbsp;it&nbsp;generates&nbsp;might&nbsp;not&nbsp;be&nbsp;exhaustive,@&nbsp;which&nbsp;means&nbsp;that&nbsp;Kind&nbsp;2&nbsp;will&nbsp;consider&nbsp;the&nbsp;contract&nbsp;unsafe.@&nbsp;This&nbsp;can&nbsp;be&nbsp;dealt&nbsp;with&nbsp;by&nbsp;adding&nbsp;a&nbsp;wild&nbsp;card&nbsp;mode:@&nbsp;mode&nbsp;wildcard&nbsp;()&nbsp;;"</span>&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="constructor">Input</span>&nbsp;input_sys&nbsp;=&nbsp;input_sys&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;param,&nbsp;node_of_scope&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InputSystem</span>.contract_gen_param&nbsp;input_sys
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Building&nbsp;transition&nbsp;system&nbsp;and&nbsp;slicing&nbsp;info.&nbsp;*)</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;trans_sys,&nbsp;input_sys_sliced&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">InputSystem</span>.contract_gen_trans_sys_of
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~preserve_sig:<span class="keyword">true</span>&nbsp;input_sys&nbsp;param
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Flags</span>.output_dir&nbsp;()&nbsp;|&gt;&nbsp;mk_dir&nbsp;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Flags</span>.output_dir&nbsp;()&nbsp;|&gt;&nbsp;<span class="constructor">Format</span>.sprintf&nbsp;<span class="string">"%s/spec_by_kind2.lus"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">LustreContractGen</span>.generate_contracts
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_sys_sliced&nbsp;trans_sys&nbsp;param&nbsp;node_of_scope&nbsp;target

&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">else</span>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;launch&nbsp;input_sys
&nbsp;&nbsp;)

;;

main&nbsp;()

<span class="comment">(*&nbsp;
&nbsp;&nbsp;&nbsp;Local&nbsp;Variables:
&nbsp;&nbsp;&nbsp;compile-command:&nbsp;"make&nbsp;-C&nbsp;..&nbsp;-k"
&nbsp;&nbsp;&nbsp;tuareg-interactive-program:&nbsp;"./kind2.top&nbsp;-I&nbsp;./_build&nbsp;-I&nbsp;./_build/SExpr"
&nbsp;&nbsp;&nbsp;indent-tabs-mode:&nbsp;nil
&nbsp;&nbsp;&nbsp;End:&nbsp;
*)</span>
&nbsp;&nbsp;
</code></body></html>